% main.tex
\documentclass[a4paper,oneside]{article}
\usepackage[top=4cm, bottom=2cm, left=2cm, right=2cm, headheight=80pt]{geometry}
\usepackage{qrcode}
\usepackage{graphicx}
\usepackage{luacode}
\usepackage{fancyhdr}
\usepackage{fontspec}
\usepackage{hyperref}
\usepackage{svg}
\usepackage{xcolor}


\begin{luacode*} 
function generate_entries()
    local datasets = load_datasets("datasets.json")
    if not datasets then
        tex.print("\\textbf{Fehler: Konnte datasets.json nicht laden!}")
        return
    end

    for _, ds in ipairs(datasets.datasets) do

        meta = [[
            \section*{]].. escape_latex(ds.name) ..[[}
            \textbf{Herausgeber:} ]] .. escape_latex(ds.publisher) .. [[ \\[0.5em]
            \textbf{Themen:} ]] .. escape_latex(table.concat(ds.topics, ", ")) .. [[ \\[0.5em]
            \textbf{Format:} ]] .. escape_latex(table.concat(ds.formats, ", ")) .. [[ \\[0.5em]
            \textbf{Größe:} ]] .. escape_latex(ds.size) .. [[ \\[0.5em]
            \textbf{Kurzbeschreibung:}\\
            ]].. escape_latex(ds.description) ..[[ \\[0.5em]
        ]]
      
        image = (ds.image_path and ds.image_path ~= "")  
                and [[\includegraphics[width=\textwidth,height=8cm,keepaspectratio]{]] .. ds.image_path .. [[}]]
                or [[\framebox[\textwidth][c]{\parbox{8cm}{\centering Bildplatzhalter}}]]

        contact = [[
            \\
            \textbf{Ansprechpartner:}  
            ]] .. escape_latex(ds.contact) .. [[
            \\[1em]
            \textbf{Verwendungszwecke:} 
            ]] ..  escape_latex(ds.use_cases) .. [[
            \\[1em]
            \textbf{Download:} 
            \url{]] .. escape_latex(ds.download_url) .. [[}\\
            \begin{center}
                \qrcode[height=3cm]{]] .. escape_latex(ds.download_url) .. [[}
            \end{center}
            \clearpage
            ]]


        output_cleaned, _ = (meta .. image .. contact) :gsub("[\n\r]", " ")
        tex.print(output_cleaned)
    end
end
\end{luacode*}

% Header configuration
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}
\lhead{
    \xlarge\textbf{Open Data Hack-Days Karlsruhe 2025}\\[0.2cm]
    \small Daten-Steckbrief
}
\rhead{
    \includesvg[width=2cm,height=2cm,keepaspectratio]{img/codeforka.svg}
}
\fancyfoot[R]{{\color{lightgray} \thepage}}
\setmainfont{Arial}

% Document
\begin{document}
    \directlua{dofile("utils.lua")}
    \directlua{generate_entries()}
\end{document}
